/**
 * é–‹ç™¼æ¸¬è©¦å·¥å…·
 * æä¾›æœ¬åœ°é–‹ç™¼ã€åµéŒ¯ã€æ¸¬è©¦è¼”åŠ©åŠŸèƒ½
 */

/**
 * å»ºç«‹æ¸¬è©¦è³‡æ–™å¿«ç…§ï¼ˆç”¨æ–¼åœ¨ç€è¦½å™¨ä¸­æª¢è¦–ï¼‰
 * @returns {Object} åŒ…å«æ‰€æœ‰é—œéµè³‡æ–™çš„ JSON ç‰©ä»¶
 */
function createDataSnapshot() {
    const exam = createExamFromSheet();

    return {
        timestamp: new Date().toISOString(),
        exam: {
            population: exam.population,
            sessionCount: exam.sessions.filter((s) => s).length - 1,
            statistics: {
                sessions: exam.sessionDistribution,
                departments: exam.departmentDistribution,
                grades: exam.gradeDistribution,
                subjects: exam.subjectDistribution,
            },
            sessions: exam.sessions.slice(1).map((session, idx) => ({
                sessionNumber: idx + 1,
                population: session.population,
                classroomCount: session.classrooms.filter((c) => c).length - 1,
                departmentGradeStats: session.departmentGradeStatistics,
                classrooms: session.classrooms
                    .slice(1)
                    .map((classroom, cidx) => ({
                        roomNumber: cidx + 1,
                        population: classroom.population,
                        classSubjectStats: classroom.classSubjectStatistics,
                        students: classroom.students.slice(0, 5), // åªå–å‰ 5 ç­†ç¯„ä¾‹
                    })),
            })),
        },
    };
}

/**
 * å°‡è³‡æ–™å¿«ç…§è¼¸å‡ºç‚º JSON æª”æ¡ˆï¼ˆé€é Web Appï¼‰
 */
function serveDataSnapshot() {
    const snapshot = createDataSnapshot();
    return ContentService.createTextOutput(
        JSON.stringify(snapshot, null, 2)
    ).setMimeType(ContentService.MimeType.JSON);
}

/**
 * å»ºç«‹ç°¡æ˜“çš„ Web ä»‹é¢ç”¨æ–¼æª¢è¦–è³‡æ–™
 */
function doGet(e) {
    var mode = e.parameter.mode || "viewer";

    if (mode === "api") {
        return serveDataSnapshot();
    }

    // æä¾› HTML æª¢è¦–å™¨
    var html =
        "<!DOCTYPE html>" +
        "<html>" +
        "<head>" +
        '<meta charset="utf-8">' +
        "<title>GAS é–‹ç™¼æ¸¬è©¦å·¥å…·</title>" +
        "<style>" +
        "body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }" +
        "h1 { color: #4ec9b0; }" +
        "pre { background: #252526; padding: 15px; border-radius: 5px; overflow-x: auto; }" +
        ".actions { margin: 20px 0; }" +
        "button { background: #0e639c; color: white; border: none; padding: 10px 20px; margin-right: 10px; cursor: pointer; border-radius: 3px; }" +
        "button:hover { background: #1177bb; }" +
        ".stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }" +
        ".stat-card { background: #252526; padding: 15px; border-radius: 5px; border-left: 3px solid #4ec9b0; }" +
        ".stat-value { font-size: 32px; font-weight: bold; color: #4ec9b0; }" +
        ".stat-label { font-size: 12px; color: #858585; margin-top: 5px; }" +
        "</style>" +
        "</head>" +
        "<body>" +
        "<h1>ğŸ“Š GAS é–‹ç™¼æ¸¬è©¦å·¥å…·</h1>" +
        '<div class="actions">' +
        '<button onclick="loadData()">ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™</button>' +
        '<button onclick="downloadJSON()">ğŸ’¾ ä¸‹è¼‰ JSON</button>' +
        '<button onclick="runTests()">ğŸ§ª åŸ·è¡Œæ¸¬è©¦</button>' +
        "</div>" +
        '<div class="stats" id="stats"></div>' +
        "<h2>ğŸ“‹ è³‡æ–™å¿«ç…§</h2>" +
        '<pre id="output">è¼‰å…¥ä¸­...</pre>' +
        "<script>" +
        "var currentData = null;" +
        "function loadData() {" +
        '  fetch(window.location.href.split("?")[0] + "?mode=api")' +
        "    .then(function(response) { return response.json(); })" +
        "    .then(function(data) { currentData = data; displayData(data); })" +
        '    .catch(function(error) { document.getElementById("output").textContent = "éŒ¯èª¤: " + error.message; });' +
        "}" +
        "function displayData(data) {" +
        "  var statsHTML = " +
        '    "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + data.exam.population + "</div><div class=\\"stat-label\\">ç¸½å­¸ç”Ÿæ•¸</div></div>" +' +
        '    "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + data.exam.sessionCount + "</div><div class=\\"stat-label\\">ç¸½ç¯€æ¬¡æ•¸</div></div>" +' +
        '    "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + Object.keys(data.exam.statistics.subjects).length + "</div><div class=\\"stat-label\\">ç§‘ç›®æ•¸é‡</div></div>" +' +
        '    "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + Object.keys(data.exam.statistics.departments).length + "</div><div class=\\"stat-label\\">ç§‘åˆ¥æ•¸é‡</div></div>";' +
        '  document.getElementById("stats").innerHTML = statsHTML;' +
        '  document.getElementById("output").textContent = JSON.stringify(data, null, 2);' +
        "}" +
        "function downloadJSON() {" +
        '  if (!currentData) return alert("è«‹å…ˆè¼‰å…¥è³‡æ–™");' +
        '  var blob = new Blob([JSON.stringify(currentData, null, 2)], { type: "application/json" });' +
        "  var url = URL.createObjectURL(blob);" +
        '  var a = document.createElement("a");' +
        "  a.href = url;" +
        '  a.download = "exam-snapshot-" + new Date().toISOString() + ".json";' +
        "  a.click();" +
        "}" +
        'function runTests() { alert("æ¸¬è©¦åŠŸèƒ½é–‹ç™¼ä¸­..."); }' +
        "loadData();" +
        "</script>" +
        "</body>" +
        "</html>";

    return HtmlService.createHtmlOutput(html).setTitle("GAS é–‹ç™¼å·¥å…·");
}

/**
 * æ¸¬è©¦ç”¨ï¼šå»ºç«‹ç¯„ä¾‹è³‡æ–™
 */
function createTestData() {
    const testStudents = [
        ["è³‡è¨Š", "ä¸€å¹´ç´š", "è³‡ä¸€ç”²", "å¼µä¸‰", "æ•¸å­¸"],
        ["è³‡è¨Š", "ä¸€å¹´ç´š", "è³‡ä¸€ç”²", "æå››", "è‹±æ–‡"],
        ["æ©Ÿæ¢°", "äºŒå¹´ç´š", "æ©ŸäºŒä¹™", "ç‹äº”", "æ•¸å­¸"],
        ["é›»æ©Ÿ", "ä¸‰å¹´ç´š", "é›»ä¸‰ä¸™", "è¶™å…­", "ç‰©ç†"],
    ];

    const sheet = EXAM_SESSIONS_SHEET;
    const startRow = 2;

    testStudents.forEach((student, idx) => {
        sheet.getRange(startRow + idx, 1, 1, 5).setValues([student]);
    });

    Logger.log("æ¸¬è©¦è³‡æ–™å»ºç«‹å®Œæˆ");
}

/**
 * æ¸…é™¤æ‰€æœ‰ç¯€æ¬¡èˆ‡è©¦å ´è³‡æ–™ï¼ˆä¿ç•™å­¸ç”Ÿæ¸…å–®ï¼‰
 */
function clearSchedulingData() {
    const sheet = EXAM_SESSIONS_SHEET;
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();

    // æ¸…é™¤ç¬¬ 6 æ¬„ï¼ˆç¯€æ¬¡ï¼‰ä¹‹å¾Œçš„æ‰€æœ‰è³‡æ–™
    if (lastCol > 5) {
        sheet.getRange(2, 6, lastRow - 1, lastCol - 5).clearContent();
    }

    Logger.log("æ’ç¨‹è³‡æ–™å·²æ¸…é™¤");
}

/**
 * é¡¯ç¤ºç•¶å‰ Exam ç‰©ä»¶çš„é™¤éŒ¯è³‡è¨Š
 */
function debugExamObject() {
    const exam = createExamFromSheet();

    Logger.log("=== Exam ç‰©ä»¶é™¤éŒ¯è³‡è¨Š ===");
    Logger.log("ç¸½äººæ•¸: " + exam.population);
    Logger.log("ç¯€æ¬¡åˆ†å¸ƒ: " + JSON.stringify(exam.sessionDistribution));
    Logger.log("ç§‘åˆ¥åˆ†å¸ƒ: " + JSON.stringify(exam.departmentDistribution));
    Logger.log("å¹´ç´šåˆ†å¸ƒ: " + JSON.stringify(exam.gradeDistribution));
    Logger.log("ç§‘ç›®åˆ†å¸ƒ: " + JSON.stringify(exam.subjectDistribution));

    exam.sessions.slice(1).forEach((session, idx) => {
        if (session && session.population > 0) {
            Logger.log("\nç¯€æ¬¡ " + (idx + 1) + ":");
            Logger.log("  äººæ•¸: " + session.population);
            Logger.log(
                "  è©¦å ´æ•¸: " + (session.classrooms.filter((c) => c).length - 1)
            );
            Logger.log(
                "  ç§‘åˆ¥-å¹´ç´šçµ±è¨ˆ: " +
                    JSON.stringify(session.departmentGradeStatistics)
            );
        }
    });
}

/**
 * æ•ˆèƒ½æ¸¬è©¦ï¼šæ¸¬é‡å‡½å¼åŸ·è¡Œæ™‚é–“
 */
function measurePerformance(functionName, ...args) {
    const startTime = new Date().getTime();

    try {
        const result = this[functionName](...args);
        const endTime = new Date().getTime();
        const duration = endTime - startTime;

        Logger.log(functionName + " åŸ·è¡Œæ™‚é–“: " + duration + "ms");
        return { result: result, duration: duration };
    } catch (error) {
        Logger.log(functionName + " åŸ·è¡ŒéŒ¯èª¤: " + error.message);
        throw error;
    }
}

/**
 * æ¯”è¼ƒå…©å€‹ Exam ç‰©ä»¶çš„å·®ç•°
 */
function compareExamSnapshots(snapshot1, snapshot2) {
    const differences = {
        populationChanged:
            snapshot1.exam.population !== snapshot2.exam.population,
        sessionCountChanged:
            snapshot1.exam.sessionCount !== snapshot2.exam.sessionCount,
        statisticsChanges: {},
    };

    // æ¯”è¼ƒçµ±è¨ˆè³‡æ–™
    ["sessions", "departments", "grades", "subjects"].forEach((key) => {
        const stats1 = JSON.stringify(snapshot1.exam.statistics[key]);
        const stats2 = JSON.stringify(snapshot2.exam.statistics[key]);
        if (stats1 !== stats2) {
            differences.statisticsChanges[key] = {
                before: snapshot1.exam.statistics[key],
                after: snapshot2.exam.statistics[key],
            };
        }
    });

    return differences;
}
